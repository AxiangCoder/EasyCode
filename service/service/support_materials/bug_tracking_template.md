# 缺陷记录与修复模板

## 1. 缺陷基础信息
- `Bug ID`：
- `标题`：
- `报告日期`：
- `发现人`：
- `所属版本/迭代`：
- `严重级别 (S0 / S1 / S2 / S3)`：
- `优先级 (P0 / P1 / P2 / P3)`：
- `状态 (新建 / 待确认 / 处理中 / 待验证 / 已关闭 / 延期 / 拒绝)`：
- `关联需求 / 任务`：

## 2. 运行环境
- `操作系统 / 浏览器 / 客户端版本`：
- `部署环境`（测试 / 预发 / 生产 等）：
- `服务版本 / 构建号`：
- `依赖服务或配置`：
- `数据准备 / 账号信息`：

## 3. 复现步骤
1. 
2. 
3. 

> **预期结果**：
> 
> **实际结果**：

## 4. 补充信息
- `日志 / 截图 / 视频 / 报警链接`：
- `自动化流水线编号`（若由 CI/CD 发现）：
- `临时规避方案`：

## 5. 修复方案与实现
- `根因分析`：
- `修复思路`：
- `涉及代码 / 配置改动`：
- `回退方案`：

## 6. 验证与回归
- `开发自测`：
  - 单元测试：
  - 集成 / 联调：
- `测试验证人`：
- `验证日期`：
- `验证结果`：通过 / 未通过（原因：）
- `回归范围 / 自动化用例`：

## 7. 关闭确认
- `关闭日期`：
- `关闭人`：
- `上线批次 / 发布窗口`：
- `监控与告警`：是否新增或更新
- `知识库链接`：复盘记录 / 技术文章

---

### 附录：严重级别参考
- **S0 阻塞**：影响核心业务或数据安全，系统无法运行，必须立即修复。
- **S1 严重**：主要功能受阻或产生严重异常，需在当前迭代内优先处理。
- **S2 一般**：功能存在缺陷但有替代路径，对体验有明显影响。
- **S3 轻微**：轻量级问题，如交互提示、UI 对齐、文案等。

> 建议结合团队工具链（如 Jira、Tapd 等）建立标准化缺陷单，确保上述字段全部覆盖。

---

## 当前缺陷记录

### 待确认 Bug 清单
- 移动端适配
- Virtual Group - flex 元素到底是为什么产生

### 已登记 Bug 列表
| Bug ID | 标题 | 详情 | 报告日期 | 严重级别 | 优先级 | 状态 | 复现步骤 | 预期结果 | 实际结果 | 解决方案 | 注意事项 | 期望值 | 关闭日期 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| ***SKETCH-1*** | Flex 布局缺少对齐与分布属性 (justify-content / align-items) | 当前的 LLM 布局分析未能稳定返回 `justify-content` 和 `align-items` 这两个关键的 flexbox 属性，导致前端渲染时无法精确控制对齐方式。父节点的 `layout` 对象中应包含 `justifyContent` 和 `alignItems` 等属性，但目前解析器未实现此功能。 | | S2 一般 | P1 | 新建 | | | | （待定） | （待定） | LLM 能够稳定返回完整的 flexbox 属性，包括 `justify-content` 和 `align-items` | |
| SKETCH-2 | `Virtual Group` 的生成逻辑不明确 | 当 LLM 分析结果包含多个布局组或离群元素时，会创建虚拟组（Virtual Group）。需要明确其生成条件、坐标计算逻辑以及如何处理嵌套层级，以确保布局的准确性。 | | S1 严重 | P1 | 已关闭 | | | | (待定) 进一步分析和重构 `_process_llm_layout_analysis` 函数。<br>**改进坐标计算逻辑**：优化边界框计算，确保Virtual Group的尺寸和位置计算准确。<br>**完善嵌套层级处理**：添加层级深度检查，避免坐标累积误差。 | (待定) | Virtual Group 的生成条件明确，坐标计算准确，嵌套层级处理正确 | 2025-10-11 |
| SKETCH-3 | Virtual Group 强制采用绝对定位 | 所有生成的 Virtual Group 均强制设置为绝对定位 (position: absolute)，即使内部为 flex 或 grid 布局。这在三次测试的 DSL 输出中均出现，导致响应式问题和 CSS 逻辑矛盾（e.g., flex 子元素无法自然流动）。<br>与源文件布局不符，源文件中的组（如列表或登录画框）应使用 relative 或 static 定位。Virtual Group 被粗暴地强制设置为绝对定位（`position: "absolute"`），即使其内部使用 flex 布局。这导致布局行为异常，失去了 flexbox 的响应式特性，造成逻辑矛盾。 | | S1 严重 | P0 | 已关闭 | | | | 根据布局类型智能选择定位方式，避免强制使用绝对定位。对于 flex 布局的 Virtual Group，应使用相对定位或静态定位。修改代码动态选择定位（基于 LLM 的 position 建议），优先 relative。 | 当前 Virtual Group 同时包含 flex 布局属性和绝对定位，这在 CSS 中是不合理的。需要根据实际布局需求选择合适的定位方式。这会放大其他布局 bug，尤其在混合场景中。 | Virtual Group 根据布局类型智能选择定位方式，保持响应式特性和 CSS 逻辑一致性 | 2025-10-11 |
| ***SKETCH-4*** | 使用 `padding` 优雅地实现布局 | 当前的布局分析主要依赖 `gap` 属性。可以探索在父容器上使用 `padding` 并结合 `gap` 的方式，以更灵活、更优雅地实现 `flex` 或 `grid` 布局，特别是在处理边缘间距时。 | | S3 轻微 | P2 | 新建 | | | | (待定) 探索在提示词中引导 LLM 识别可以转换为 `padding` 的布局模式。 | （待定） | 能够智能识别并使用 `padding` 和 `gap` 组合实现更优雅的布局 | |
| ***SKETCH-5*** | ListPage 布局不稳定且 Flex gap 计算错误 | 在多次测试中，ListPage 的 DSL 输出布局不一致，导致布局不稳定。这表现为：1) 布局有时完全错误，可能过度使用 absolute 定位或错误分组。2) 即使布局被识别为 flex，其 `gap` 值也与根据源文件坐标计算出的实际视觉间距不符，导致布局渲染错误。 | | S1 严重 | P0 | 新建 | | | | (待定) 优化 LLM 分步调用，确保分组步骤优先单一 flex group，并准确计算 gap。 | 可能与 LLM 输出不确定性相关，需要更多测试数据。 | ListPage 布局稳定一致，正确识别布局，并准确计算 gap 值 | |
| ***SKETCH-7*** | 未考虑嵌套路由 | | 2025-09-29 | S0 阻塞 | P0 | 处理中 | 1. 使用当前路由生成逻辑<br>2. 配置嵌套路由<br>3. 生成结果错误 | 支持嵌套路由配置 | 嵌套路由未生成或错误 | | | | |
| ***SKETCH-8*** | 颜色没渲染出来 | | 2025-01-27 | S1 严重 | P1 | 新建 | 1. 使用 DSL 生成前端项目<br>2. 启动项目并访问页面<br>3. 检查页面元素颜色渲染情况 | 所有 DSL 节点都应正确渲染颜色样式 | 元素颜色未正确显示或显示异常 | | | | |
| ***SKETCH-9*** | `src` 目录缺少路径别名 | | 2025-09-29 | S2 一般 | P1 | 新建 | 1. 查看前端模板配置<br>2. 尝试在模块引入中使用 `@/` 或 `src/` 别名<br>3. 编译报错显示未解析的路径别名 | 模块引用支持统一的路径别名 | 模块必须使用相对路径，维护成本高 | | | | |
| SKETCH-10 | DSL 根节点区分缺失 | | 2025-09-29 | S0 阻塞 | P0 | 已关闭 | 1. 在 DSL 输入中加载页面结构<br>2. 检查节点层级信息<br>3. 无法标记根节点 | DSL 能识别并标注根节点 | 所有节点缺少根节点信息 | | | | 2025-09-29 |
| SKETCH-11 | `router.path` 值异常 | | 2025-09-29 | S0 阻塞 | P0 | 已关闭 | 1. 生成代码<br>2. 检查生成的 `router.path`<br>3. 与预期不符 | `router.path` 与页面配置一致 | `router.path` 错误 | | | | 2025-09-29 |
| SKETCH-12 | `router.tsx` 语法错误 | | 2025-09-29 | S0 阻塞 | P0 | 已关闭 | 1. 生成路由文件<br>2. 打开 `router.tsx`<br>3. 编译时报语法错误 | `router.tsx` 符合语法规范 | 存在语法错误导致编译失败 | | | | 2025-09-29 |
| SKETCH-13 | TSX 样式缺少 px 单位 | | 2025-09-29 | S2 一般 | P1 | 已关闭 | 1. 生成前端代码<br>2. 打开页面组件 TSX 文件<br>3. 检查内联样式数值未带单位 | 样式数值应自动补全 `px` 等单位 | 数值样式直接输出裸数字导致渲染不符 | | | | 2025-09-29 |
| SKETCH-14 | 生成项目未渲染路由 | | 2025-09-29 | S0 阻塞 | P0 | 已关闭 | 1. 生成项目并启动 dev 服务器<br>2. 访问根路径<br>3. 页面无内容且 console 显示路由未挂载 | 默认渲染 router 中的首个页面路由 | 项目启动后无法渲染任何路由页面 | | | | 2025-09-29 |
| SKETCH-15 | 内联样式语法错误 | | 2025-09-29 | S0 阻塞 | P0 | 已关闭 | 1. 生成项目并打开 TSX 组件文件<br>2. 检查自动生成的 `style` 对象<br>3. 编译时报内联样式语法错误 | 生成的内联样式应符合 React 语法规范 | 自动生成的样式字段非法导致编译失败 | | | | 2025-09-29 |
| ***SKETCH-16*** | 根目录第一个节点不应使用绝对定位 | | 2025-01-27 | S2 一般 | P1 | 新建 | 1. 使用 DSL 生成前端项目<br>2. 检查根目录下第一个节点（页面级组件）的样式<br>3. 发现使用了绝对定位 | 页面级组件应使用相对定位或流式布局 | 根目录第一个节点错误地使用了绝对定位 | | | | |
| SKETCH-17 | 全局样式丢失：未提供令牌文件时跳过所有样式解析 | | 2025-10-09 | S1 严重 | P0 | 已关闭 | 1. 运行一个不带 design_tokens.json 文件的 Sketch 到 DSL 的转换任务。<br>2. 检查输出的 dsl.json 文件。 | 即使没有令牌文件，节点也应包含从源文件解析出的原始样式值（如背景色、文字颜色等）。 | 所有节点的 style 对象都只包含 width 和 height，所有其他样式信息全部丢失。 | | | | 2025-10-09 |
| ***SKETCH-18*** | 文本内容丢失：解析器从错误的字段读取文本 | | 2025-10-09 | S1 严重 | P0 | 新建 | 1. 运行一个包含文本节点的 Sketch 到 DSL 的转换任务。<br>2. 检查输出 dsl.json 中对应的 text 节点。 | text 节点的 content.text 字段应包含源文件中定义的字符串。 | text 节点的 content.text 字段为 null。 | | | | |
| SKETCH-19 | 代码生成器忽略DSL中的Flex布局规则 | | 2025-10-09 | S1 严重 | P0 | 已关闭 | 1. 使用一个包含 layout.type 为 'flex' 的 DSL 文件生成前端代码。<br>2. 检查生成的 TSX 组件代码。 | 包含 layout.type: 'flex' 的 div 应该生成包含 'display: "flex"', 'flexDirection: "..."' 等样式的代码。 | 生成的 style 对象中完全没有 flex 布局相关的样式，layout 对象中的 flex 规则被忽略。 | | | | 2025-10-09 |
| ***SKETCH-20*** | LLM布局模式下，子节点未按视觉顺序排序 | | 2025-10-09 | S2 一般 | P2 | 处理中 | 1. 使用一个其子节点可被LLM识别为单一Flex布局（行或列）的Sketch文件进行转换。<br>2. 确保文件中子图层的列表顺序与它们在画布上的视觉顺序不一致。<br>3. 检查生成的代码（如TSX文件）。 | 生成的代码中，Flex容器内的子元素DOM顺序应与其在画布上的视觉顺序（从上到下或从左到右）一致。 | 子元素的DOM顺序与其在Sketch文件内部的图层列表顺序一致，而非正确的视觉顺序，导致最终渲染的页面元素排序错误。 | **根因**: Bug仅存在于使用LLM进行布局分析的路径中。当LLM将一组子节点识别为单一Flex布局时（`is_simple_group`为true），代码会直接遍历原始的、未排序的图层列表来生成子节点。而不使用LLM的规则路径（`_analyze_layout_with_rules`）因为对图层列表进行了就地排序，所以没有此Bug。<br>**修复思路**: 在LLM分析为"简单布局"的代码分支中，增加一步排序逻辑：在遍历子图层列表之前，根据LLM返回的布局方向（`row`或`column`），使用其`frame`的`x`或`y`坐标对列表进行排序。 | | | |
| SKETCH-21 | 容器节点未被转换为Flex容器 | | 2025-10-09 | S2 一般 | P1 | 已关闭 | 1. 使用一个其子节点可被LLM识别为Flex布局的容器节点进行转换。<br>2. 检查输出的DSL和最终生成的代码。 | 父容器节点本身应被赋予 'layout: { type: "flex", ... }' 属性，并在生成的代码中获得 'display: "flex"' 样式。 | 父容器未获得Flex属性。系统创建了一个多余的 'Virtual Group' 子节点来承载Flex布局，并使用绝对定位，导致DOM结构和布局不正确。 | | | | 2025-10-09 |
| ***SKETCH-22*** | 未能将绝对定位的嵌套文本智能转换为Flex居中布局 | | 2025-10-09 | S2 一般 | P2 | 新建 | 1. 转换一个将单个文本图层置于编组中并居中的设计。<br>2. 检查输出的DSL。 | 父容器应被转换为 `display: flex` 并带有居中对齐的属性，以实现弹性居中。 | 父容器被设置为绝对布局，其内部的文本子节点也被绝对定位，失去了布局的灵活性。 | | | | |
| ***SKETCH-23*** | 布局分析无法为同级节点的子集创建嵌套Flex布局 | | 2025-10-09 | S2 一般 | P2 | 新建 | 1. 转换一个设计，其中多个子节点整体呈纵向排列，但其中某两个子节点在视觉上是横向排列的。<br>2. 检查输出的DSL。 | 解析器应为那两个横向排列的节点创建一个嵌套的、`direction: row` 的虚拟Flex组。 | 所有子节点被统一放入一个大的 `direction: column` 的Flex布局中，导致局部布局错误。 | | | | |
| SKETCH-24 | 顶部水平小矩形被误分组到垂直 flex | 根据 `preview.png` 的视觉布局和源文件 `media/conversion_inputs/6B6771BA-E1C8-40F1-938C-19EDD4C50371.json`，顶部的多个小方块应为水平排列。但在输出文件 `media/conversion_out/18c0ca8d-0679-48d6-8ef9-f6a5b52d2191/dsl.json` 中，第一个方块元素（ID: `50899E5A-12A1-4FDB-857B-2DC204D294AC`）被错误地分入了下方的 flex 纵向布局中，而不是它应该在的 flex 横向布局中。 | | S0 阻塞 | P1 | 已关闭 | 1. 运行转换任务<br>2. 检查 DSL 中的 ListPage flex groups<br>3. 顶部小矩形分组错误 | 顶部小矩形全部分组为 row flex | 第一个小矩形被误放进 column flex | 在 post_process_groups 中，放宽尺寸标准差阈值到 10px，并优先检测 y 一致的水平行 | 可能与 LLM 输出不确定性相关，需要更多测试数据 | 后处理后，顶部小矩形全部分组为 row flex，gap 根据 x 间距计算（e.g., 16px），top/left 匹配源文件第一个元素位置 | |
| ***SKETCH-25*** | 代码生成器未实现画板节点的 Flex 布局 | 根据新的 DSL 规范，画板（页面级组件）节点现在可以拥有 `layout: { type: 'flex', ... }` 属性。然而，代码生成阶段并未适配此改动，导致最终生成的代码中缺少对应的 `display: flex` 等 CSS 样式，使得 DSL 中的流式布局设计失效。 | 2025-10-11 | S1 严重 | P0 | 新建 | 1. 使用修复后的解析器生成一份包含 `flex` 布局画板的 DSL。<br>2. 使用该 DSL 生成前端代码。<br>3. 检查画板组件对应的 CSS 样式。 | 画板组件的 div 应包含 `display: flex` 样式。 | 生成的样式中缺少 `display: flex`。 | (待定) 修改代码生成器逻辑，使其能够为 `layout.type` 为 `flex` 的节点生成正确的 CSS。 | | | |
| ***SKETCH-26*** | 页面级组件布局处理缺陷 | 页面级组件在 DSL 生成过程中存在两个问题：1) 被特殊处理跳过布局分析，导致其 `layout` 字段为空对象 `{}`，无法利用 flex、grid 等布局类型；2) 即使识别为 flex 布局，仍然被强制加上 `position: "absolute"`，导致布局逻辑矛盾和响应式能力丧失。这限制了页面级组件的布局能力，特别是在多画板场景下无法实现响应式布局。 | 2025-01-27 | S1 严重 | P0 | 新建 | 1. 使用包含多个画板的 Sketch 文件进行转换<br>2. 检查生成的 DSL 中页面级组件的 layout 字段<br>3. 发现页面级组件的 layout 为空或包含矛盾的布局属性 | 页面级组件应能利用 layout.type 属性支持 flex、grid 等布局，且不应被强制绝对定位 | 页面级组件的 layout 字段为空或包含矛盾的布局属性 | 修改 `_traverse_layer` 方法，移除 `is_root_page` 的特殊处理，让页面级组件也经过布局分析，并根据布局类型智能选择定位方式 | 页面级组件能够根据布局类型智能选择定位方式，支持多画板的响应式布局，避免布局逻辑矛盾 | | |
|| ***SKETCH-27*** | 几何校验过于严格导致布局组被错误拒绝 | 节点 FC0CFB19-3012-4DE1-B434-A9A02A9FF392（"画框"）包含多个子元素（图形、图形2、图形2备份等），LLM 正确识别了这些元素应该组成一个 column 布局，并计算出了正确的间距信息（spacings: [30, 30, 30, 30, -30, 39]）。但是几何校验逻辑过于严格，在 `_validate_groups_geometry` 方法中检查 X 坐标标准差时发现超过 `LAYOUT_X_THRESHOLD` 阈值，导致整个布局组被拒绝。日志显示："一个 COLUMN 组因 X 坐标方差过大而被拒绝"，最终节点没有计算 gap 属性。 | 2025-10-13 | S1 严重 | P0 | 新建 | 1. 运行转换任务，检查节点 FC0CFB19-3012-4DE1-B434-A9A02A9FF392 的布局分析过程<br>2. 查看日志第52行："一个 COLUMN 组因 X 坐标方差过大而被拒绝"<br>3. 检查 DSL 输出发现该节点的 layout 只有 type 和 direction，缺少 gap 属性 | 节点应能正确计算 gap 属性，布局分析不应因几何校验过于严格而失败 | 节点缺少 gap 属性，布局分析因几何校验失败而回退到绝对定位 | 方案1（推荐）：对于 column 布局，几何校验应该检查 Y 坐标的方差而非 X 坐标；方案2：适当放宽 `LAYOUT_X_THRESHOLD` 阈值；方案3：为 LLM 识别的布局组增加容错性，降低校验严格度 | 几何校验的逻辑存在错误：对于垂直（column）布局，应该允许子元素在水平方向有一定偏移，只需要检查垂直方向的对齐即可 | LLM 正确识别的布局组能够通过几何校验并正确计算 gap 属性 | | |
