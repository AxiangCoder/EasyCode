# 布局分析规则

本文档旨在说明 `converter/parsers/sketch/converter.py` 中用于分析设计图层布局的各种策略。

---

## 策略一：“混合专家-仲裁”模式

策略一为当前采用的核心策略，名为“混合专家-仲裁”模式。它取代了旧的“规则优先、贪心决策”模式。

### 1. 核心设计

#### 1.1 设计思路：“专家委员会”模式

当前策略的核心思路，是将复杂的布局识别任务，看作一个需要“专家委员会”来解决的问题，其原则是**“并行咨询，统一仲裁”**。

我们承认，委员会中的任何单一专家都不是万能的：
*   **几何分析引擎 (`_analyze_layout_with_rules`)**：像一位严谨的“几何学家”，对于精确对齐的行列布局，它的判断快速、准确、100% 可靠。但它看不懂任何“设计意图”。
*   **语义分析引擎 (`_analyze_layout_with_llm`)**：像一位经验丰富的“设计师”，能识别出功能内聚的复杂组件（如卡片、表单），理解布局的“神似”。但它的判断基于概率，偶尔会出错，且不擅长精确的数学计算。

因此，我们的策略是让所有专家**并行工作**，将各自的意见（候选组）都收集到一张公共的“会议桌”（一个候选列表）上，最后由一个“首席仲裁官”（`_resolve_group_conflicts` 函数）来审查所有意见，解决分歧，并做出全局最优的裁决。

#### 1.2 LLM 与 Python 计算的关系及优先级

这是整个设计的关键，体现了**“各司其职，信任专长”**的原则。

*   **明确分工**:
    *   **LLM (负责“分组”)**: 它的核心任务是回答“**是什么**？”这个问题，即从语义和视觉模式上判断“**哪些**元素应该被看作一个逻辑整体？”。它负责的是最模糊、最考验“经验”的**分组 (Grouping)** 任务。
    *   **Python (负责“计算”)**: 它的核心任务是回答“**怎么样**？”这个问题，即对于一个已经确定的分组，它的**精确属性是怎么样**的？（例如 `gap` 是多少像素？）。这些都可以通过坐标进行精确的数学计算，因此必须由 100% 可靠的 Python 代码来完成。

*   **信任与优先级**:
    1.  **计算优先 Python**: 对于任何可以被客观、精确计算的任务（如测量距离、计算尺寸），我们**永远信任 Python 代码**。我们绝不让 LLM 去“猜测”一个像素值，这保证了最终输出样式的精确性。
    2.  **分组并行处理**: 在“分组”这个任务上，Python 规则引擎和 LLM 是平等的“专家”，它们并行提出建议。规则引擎的建议因为基于数学，通常“对齐强度”得分更高；而 LLM 的建议则能覆盖规则无法识别的场景。最终由仲裁者根据证据（得分）来决定采纳哪个。

*   **工作流**:
    整个流程是一个清晰的管道：LLM 提出一个分组建议 → 该建议立刻被交给 Python 的 `_calculate_layout_properties` 函数去计算出精确的几何属性 → 最终，这个“附加上了精确属性的建议”才会被送到仲裁者那里去决策。

#### 1.3 设计模式

此架构在思想上最接近 **“黑板系统”（Blackboard System）** 设计模式。不同的“专家”（分析引擎）将自己的见解写入公共的“黑板”（候选组列表），再由一个“控制器”（仲裁函数）来综合信息，形成最终结论。

### 2. 优缺点分析

#### 优点

1.  **结果质量高**：通过结合“几何学家”的精确和“设计师”的洞察力，并由一个公正的“仲裁官”来做最终决定，产出的布局结果在准确性和鲁棒性上都达到了很高的水平。
2.  **可扩展性强**：此架构可以方便地加入新的“专家”（例如，未来可以增加一个基于图像识别的分析引擎），只需让它也将结果写入“黑板”即可，核心仲裁流程无需改动。
3.  **关注点分离**：每个模块职责单一（规则引擎管几何，LLM 管语义，仲裁者管决策），使得代码逻辑更清晰，易于维护和单独优化。

#### 缺点

1.  **性能与成本**：并行运行多个引擎，特别是包含网络请求的 LLM，使得整个过程比单一算法更慢、成本更高。
2.  **系统复杂性**：拥有更多的“活动部件”，特别是仲裁者的逻辑非常关键，需要精细调整，增加了整体的系统复杂性。
3.  **外部依赖**：对 LLM 服务的依赖，带来了可用性、稳定性和潜在的模型行为变更的风险。

---
*此文档描述的是 `converter/parsers/sketch/converter.py` 中当前使用的布局分析策略。*