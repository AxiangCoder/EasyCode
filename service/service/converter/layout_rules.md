# 布局分析规则（重构后）

本文档详细说明了在 `converter/parsers/sketch/converter.py` 中实现的、用于分析设计图层布局的、经过重构的混合策略。该策略旨在通过并行分析和冲突解决来提高布局识别的准确性和鲁棒性。

## 1. 混合分析策略

重构后的核心思想是放弃旧的“规则优先、贪心决策”模式，转而采用一种“并行分析、统一仲裁”的策略。

**新的工作流程如下：**

1.  **并行生成候选组 (Candidate Generation)**: 对于一组给定的子图层，系统会同时从两个独立的分析引擎获取布局建议：
    *   **几何分析引擎 (`_analyze_layout_with_rules`)**: 此函数现在会找出**所有**符合几何对齐条件的潜在布局组（行和列），即使它们之间存在成员重叠。它不再做出任何最终决策，而是提供一份详尽的“几何候选组”列表。
    *   **语义分析引擎 (`_analyze_layout_with_llm`)**: LLM 引擎并行运行，从语义和视觉模式的角度提供另一份“语义候选组”列表。

2.  **核心仲裁：分组冲突解决 (Core Arbitration)**:
    *   上述两份候选组列表被合并成一个包含所有潜在布局可能性的、允许重叠的完整列表。
    *   这个完整的列表被提交给 `_resolve_group_conflicts` 函数。此函数现在是整个布局分析流程的**核心仲裁者**。
    *   它通过评估每个候选组的“强度”（例如，对齐方差、成员数量等），来解决成员重叠的冲突，并从中挑选出最优的、互不冲突的一组最终布局。

3.  **确定离群点 (Outlier Detection)**: 在最终布局组被确定后，任何不属于任何一个组的图层都被视为“离群点”，并将在布局中采用绝对定位。

这种新的策略激活了原先失效的 `_resolve_group_conflicts` 函数，并从根本上解决了旧贪心算法导致的过早做出错误决策的问题。

## 2. 分析引擎详情

### 2.1. 几何分析引擎

-   **分组检测逻辑**:
    -   **列检测 (`flex-column`)**: 如果一组图层的 **x-坐标**标准差在 `LAYOUT_X_THRESHOLD` 阈值内，则视为对齐。
    -   **行检测 (`flex-row`)**: 如果一组图层的 **y-坐标**标准差在 `LAYOUT_Y_THRESHOLD` 阈值内，则视为对齐。
-   **简化的 Gap 计算**:
    -   一旦识别出 `flex` 组，其元素之间的 `gap` 仍由 `_calculate_layout_properties` 函数通过计算间距的**算术平均值**得出。
    > **待改进**: 这种方法对异常值（如设计稿中的微小错位）非常敏感。一个异常的间距会显著影响平均值，导致计算出的 `gap` 不准确。这是 `SKETCH-5` 缺陷的核心原因，未来可以改进为使用中位数或更鲁棒的统计方法。

### 2.2. 语义分析引擎

-   **角色**: LLM 不再是后备方案，而是作为并行的分析引擎，专注于识别几何规则难以覆盖的、更侧重“设计意图”的复杂布局。
-   **过程**:
    1.  **LLM 负责分组**: 使用 `layout_grouping_prompt.md` 提示将图层发送给 LLM，该提示指示模型识别逻辑组。
    2.  **Python 负责计算**: LLM 提出的组同样会被 `_calculate_layout_properties` 函数处理，以计算其 `gap` 等几何属性。

## 3. Virtual Group 生成机制

`Virtual Group`（虚拟组）的生成机制保持不变，由 `_process_layout_analysis` 函数实现。

1.  **触发条件**: 当核心仲裁步骤 (`_resolve_group_conflicts`) 成功识别出至少一个最终布局组时。
2.  **生成步骤**:
    *   为每个最终的 `layout_group` 计算一个能完全包围其所有子图层的最小边界框。
    *   在 DSL 中创建一个新的 `div` 节点，并标记 `group_identifier` 为 `Virtual Group - <type>`。
    *   这个 `Virtual Group` 在其父容器中被赋予 `position: absolute` 绝对定位。
    *   原始的布局信息（如 `type: flex`, `direction: column`, `gap: ...`）被保留在 `Virtual Group` 的 `layout` 属性中。
    *   原分组内的所有子图层坐标被重新计算，以相对于其所属的 `Virtual Group` 定位。